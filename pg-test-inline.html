<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prueba catálogo (inline)</title>
<style>
  /* Estilos mínimos, namespaced */
  .pg-catalog-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .pg-card{border:1px solid #eaeaea;border-radius:12px;padding:1rem;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.05)}
  .pg-card img{width:100%;height:180px;object-fit:cover;border-radius:10px}
  .pg-meta{display:flex;justify-content:space-between;align-items:center;margin:.5rem 0}
  .pg-form{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem}
  .pg-form .pg-full{grid-column:1 / -1}
  #pg-admin-panel{margin:1rem 0;border:1px dashed #ccc;padding:1rem;border-radius:8px}
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
</style>
</head>
<body>
<h1>Prueba catálogo (localStorage)</h1>
<p>Tip: añade <code>?admin=1</code> a la URL o usa <strong>Ctrl+Alt+A</strong> para mostrar/ocultar el panel.</p>

<section id="catalog-root" style="margin-top:1rem;">
  <h2>Nuestras Prótesis</h2>
  <div id="pg-catalog-grid" class="pg-catalog-grid"></div>
</section>

<!-- Semilla inicial opcional -->
<script id="pg-default-catalog" type="application/json">[
  {"id":"seed-001","sku":"KNEE-K9-01","name":"Prótesis Rodilla K9","category":"rodilla","price":1999,"stock":3,"image":"","description":"Semilla de prueba"}
]</script>

<script>
(function(){
  'use strict';
  var LS_KEY='pg_catalog_v3', DOC=document;

  function $id(id){return DOC.getElementById(id)}
  function uid(){try{if(window.crypto&&window.crypto.randomUUID) return crypto.randomUUID();}catch(e){} return 'id-'+Math.random().toString(36).slice(2)+Date.now()}
  function currency(n){try{return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(n||0))}catch(e){var x=Number(n||0);return 'MXN $'+x.toFixed(2)}}
  function readSeed(){var el=$id('pg-default-catalog'); if(!el) return []; try{return JSON.parse((el.textContent||'').trim())||[]}catch(e){return []}}
  function getData(){try{var raw=localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw)}catch(e){} return readSeed()}
  function setData(arr){try{localStorage.setItem(LS_KEY, JSON.stringify(arr))}catch(e){}}

  function ensureAdminPanel(show){
    var p=$id('pg-admin-panel');
    if(!p){
      p=DOC.createElement('section'); p.id='pg-admin-panel';
      p.innerHTML =
        '<h3>Administrar catálogo</h3>'+
        '<form id="pg-form" class="pg-form" autocomplete="off">'+
          '<input id="pg-id" type="hidden">'+
          '<div><label>Nombre</label><input id="pg-name" required></div>'+
          '<div><label>SKU</label><input id="pg-sku" required></div>'+
          '<div><label>Categoría</label><input id="pg-cat" placeholder="rodilla, codo..."></div>'+
          '<div><label>Precio (MXN)</label><input id="pg-price" type="number" step="0.01" required></div>'+
          '<div><label>Stock</label><input id="pg-stock" type="number" step="1" min="0" value="0"></div>'+
          '<div><label>Imagen (URL)</label><input id="pg-img" placeholder=""></div>'+
          '<div class="pg-full"><label>Descripción</label><textarea id="pg-desc" rows="2"></textarea></div>'+
          '<div class="pg-full"><button type="submit" id="pg-save">Guardar</button> <button type="button" id="pg-clear">Limpiar</button></div>'+
        '</form>';
      DOC.body.insertBefore(p, $id('catalog-root'));
      // eventos
      $id('pg-form').addEventListener('submit', function(e){
        e.preventDefault();
        var item={
          id: $id('pg-id').value || uid(),
          name: ($id('pg-name').value||'').trim(),
          sku: ($id('pg-sku').value||'').trim(),
          category: ($id('pg-cat').value||'').trim(),
          price: parseFloat($id('pg-price').value),
          stock: parseInt($id('pg-stock').value||'0',10),
          image: ($id('pg-img').value||'').trim(),
          description: ($id('pg-desc').value||'').trim(),
          updatedAt: new Date().toISOString()
        };
        if(!item.name || !item.sku || isNaN(item.price)){ alert('Nombre, SKU y Precio son obligatorios.'); return; }
        upsert(item); clearForm(); render();
      });
      $id('pg-clear').addEventListener('click', clearForm);
    }
    p.style.display = show ? 'block' : 'none';
  }

  function clearForm(){
    var ids=['pg-id','pg-name','pg-sku','pg-cat','pg-price','pg-stock','pg-img','pg-desc'];
    for(var i=0;i<ids.length;i++){ var el=$id(ids[i]); if(!el) continue; el.value=(ids[i]==='pg-stock')?0:''; }
    $id('pg-save').textContent='Guardar';
  }

  function fillForm(p){
    $id('pg-id').value=p.id||'';
    $id('pg-name').value=p.name||'';
    $id('pg-sku').value=p.sku||'';
    $id('pg-cat').value=p.category||'';
    $id('pg-price').value=(p.price!=null?p.price:'');
    $id('pg-stock').value=(p.stock!=null?p.stock:0);
    $id('pg-img').value=p.image||'';
    $id('pg-desc').value=p.description||'';
    $id('pg-save').textContent='Actualizar';
  }

  function upsert(item){
    var data=getData(), i, idx=-1;
    for(i=0;i<data.length;i++){
      var p=data[i];
      if((p.id && item.id && p.id===item.id) || (p.sku && item.sku && p.sku===item.sku)){ idx=i; break; }
    }
    if(idx>=0){
      var base=data[idx]; for(var k in item) if(item.hasOwnProperty(k)) base[k]=item[k];
      data[idx]=base;
    }else{
      if(!item.id) item.id=uid();
      data.push(item);
    }
    setData(data);
  }

  function removeById(id){
    var data=getData(), out=[];
    for(var i=0;i<data.length;i++){ if(data[i].id!==id) out.push(data[i]); }
    setData(out);
  }

  function render(){
    var grid=$id('pg-catalog-grid');
    while(grid.firstChild) grid.removeChild(grid.firstChild);
    var data=getData();
    if(!data.length){ var p=DOC.createElement('p'); p.appendChild(DOC.createTextNode('No hay artículos.')); grid.appendChild(p); return; }
    for(var i=0;i<data.length;i++){
      (function(p){
        var card=DOC.createElement('article'); card.className='pg-card'; card.setAttribute('data-id',p.id||'');
        var img=DOC.createElement('img'); img.src=p.image||''; img.alt=p.name||''; img.onerror=function(){ this.removeAttribute('src'); };
        var h4=DOC.createElement('h4'); h4.appendChild(DOC.createTextNode(p.name||'(Sin nombre)'));
        var m1=DOC.createElement('div'); m1.className='pg-meta';
        var s1=DOC.createElement('span'); s1.appendChild(DOC.createTextNode(currency(p.price)));
        var s2=DOC.createElement('small'); s2.appendChild(DOC.createTextNode('SKU: '+(p.sku||'-')));
        m1.appendChild(s1); m1.appendChild(s2);
        var desc=DOC.createElement('p'); desc.appendChild(DOC.createTextNode(p.description||''));
        var m2=DOC.createElement('div'); m2.className='pg-meta';
        var st=DOC.createElement('small'); st.appendChild(DOC.createTextNode('Stock: '+(isFinite(p.stock)?p.stock:0)));
        var wrap=DOC.createElement('div');
        var b1=DOC.createElement('button'); b1.appendChild(DOC.createTextNode('Editar'));
        var b2=DOC.createElement('button'); b2.appendChild(DOC.createTextNode('Eliminar'));
        wrap.appendChild(b1); wrap.appendChild(b2);
        m2.appendChild(st); m2.appendChild(wrap);
        card.appendChild(img); card.appendChild(h4); card.appendChild(m1); card.appendChild(desc); card.appendChild(m2);
        grid.appendChild(card);
        b1.onclick=function(){ fillForm(p); ensureAdminPanel(true); };
        b2.onclick=function(){ if(confirm('¿Eliminar?')){ removeById(p.id); render(); } };
      })(data[i]);
    }
  }

  // Boot
  DOC.addEventListener('DOMContentLoaded', function(){
    if(!localStorage.getItem(LS_KEY)){ var seed=readSeed(); if(seed && seed.length) setData(seed); }
    render();

    // Mostrar panel según query o con el atajo
    var show = (location.search||'').indexOf('admin=1')>=0;
    ensureAdminPanel(show);
    DOC.addEventListener('keydown', function(e){
      var k=e.key||e.keyCode;
      if(e.ctrlKey && e.altKey && (k==='a'||k==='A'||k===65)){
        var panel=$id('pg-admin-panel'); var visible=panel && panel.style.display!=='none';
        ensureAdminPanel(!visible);
      }
    });
  });
})();
</script>
</body>
</html>
